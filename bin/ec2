#!/usr/bin/env bash
# ec2 — EC2 Ops Kit CLI
# One-liner management for AWS EC2 instances.
#
# Usage: ec2 <command> [options]
# Run 'ec2 help' for details.

set -euo pipefail

# ── Resolve project root ──────────────────────────────────────────────
EC2_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
export EC2_ROOT

# ── Source libraries ──────────────────────────────────────────────────
# shellcheck source=../lib/core.sh
source "${EC2_ROOT}/lib/core.sh"
# shellcheck source=../lib/cmd_instances.sh
source "${EC2_ROOT}/lib/cmd_instances.sh"
# shellcheck source=../lib/cmd_network.sh
source "${EC2_ROOT}/lib/cmd_network.sh"
# shellcheck source=../lib/cmd_spot.sh
source "${EC2_ROOT}/lib/cmd_spot.sh"
# shellcheck source=../lib/cmd_cleanup.sh
source "${EC2_ROOT}/lib/cmd_cleanup.sh"

# ── Version ───────────────────────────────────────────────────────────
EC2_VERSION="2.0.0"

# ── Help (defined early so it can be called from routing) ─────────────
show_help() {
  cat <<HELP
${BOLD}EC2 Ops Kit${NC} v${EC2_VERSION}
Fast, safe one-liner management for AWS EC2 instances.

${BOLD}USAGE${NC}
  ec2 <command> [options]

${BOLD}COMMANDS${NC}
  ${CYAN}Instance Management${NC}
    list              List instances (Name, ID, state, type, IPs, AZ, time)
    info <name|id>    Detailed info about one instance
    up                Create instance from preset
    start <name|id>   Start a stopped instance
    stop <name|id>    Stop a running instance
    terminate <n|id>  Terminate (destroy) an instance

  ${CYAN}Connectivity${NC}
    ssh <name|id>     SSH into an instance (or print the command)
    eip <action>      Manage Elastic IPs (list/alloc/assoc/disassoc/release)

  ${CYAN}Spot Instances${NC}
    spot <action>     Spot management (list/prices/history/cancel/interruption)

  ${CYAN}Maintenance${NC}
    cleanup           Scan for orphaned EIPs, volumes, expired instances
    presets           List available instance presets

  ${CYAN}Other${NC}
    help              Show this help
    version           Show version

${BOLD}GLOBAL OPTIONS${NC}
  --profile PROF    AWS profile (overrides config)
  --region REG      AWS region (overrides config)
  --dry-run         Preview destructive operations without executing
  --yes, -y         Skip confirmation prompts
  --config FILE     Path to config.yaml
  --debug           Verbose debug output
  --mock            Mock mode for testing (no AWS calls)

${BOLD}EXAMPLES${NC}
  ec2 list
  ec2 up --preset cpu-small --name dev-box
  ec2 up --preset gpu-t4 --name training --spot --ttl-hours 8
  ec2 ssh dev-box
  ec2 ssh dev-box --print
  ec2 stop dev-box
  ec2 terminate dev-box
  ec2 eip list
  ec2 eip alloc my-ip
  ec2 spot prices
  ec2 cleanup --days 3
  ec2 --profile work --region eu-west-1 list

${BOLD}CONFIGURATION${NC}
  Config:   ${EC2_ROOT}/config.yaml
  Presets:  ${EC2_ROOT}/presets/
  Docs:     ${EC2_ROOT}/README.md
  Setup:    ${EC2_ROOT}/bootstrap.sh

HELP
}

# ── Parse global options (before command) ─────────────────────────────
while [[ $# -gt 0 ]]; do
  # shellcheck disable=SC2034  # EC2_PROFILE used by sourced libs
  case "$1" in
    --profile)  EC2_PROFILE="$2"; shift 2 ;;
    --region)   EC2_REGION="$2"; shift 2 ;;
    --dry-run)  EC2_DRY_RUN="true"; shift ;;
    --yes|-y)   EC2_YES="true"; shift ;;
    --config)   EC2_CONFIG_FILE="$2"; shift 2 ;;
    --debug)    EC2_DEBUG="1"; shift ;;
    --mock)     EC2_MOCK="true"; shift ;;
    --version)  echo "ec2 ops kit v${EC2_VERSION}"; exit 0 ;;
    -*)
      # Flag that belongs to a subcommand
      break
      ;;
    *)
      # First non-flag argument is the command
      break
      ;;
  esac
done

COMMAND="${1:-help}"
shift 2>/dev/null || true

# ── Initialize ────────────────────────────────────────────────────────
load_config

case "$COMMAND" in
  help|version|--help|-h|presets)
    # These commands don't need AWS CLI
    ;;
  *)
    check_aws_cli
    print_context
    if [[ "$EC2_DRY_RUN" == "true" ]]; then
      printf '%b\n' "${YELLOW}[dry-run mode]${NC}"
    fi
    printf '\n'
    ;;
esac

# ── Command routing ───────────────────────────────────────────────────
case "$COMMAND" in
  # Instance management
  list|ls)          cmd_list "$@" ;;
  info|show)        cmd_info "$@" ;;
  up|create|launch) cmd_up "$@" ;;
  start)            cmd_start "$@" ;;
  stop)             cmd_stop "$@" ;;
  terminate|rm)     cmd_terminate "$@" ;;

  # Network
  ssh)              cmd_ssh "$@" ;;
  eip)              cmd_eip "$@" ;;

  # Spot
  spot)             cmd_spot "$@" ;;

  # Maintenance
  cleanup|clean)    cmd_cleanup "$@" ;;

  # Presets
  presets)
    printf '\n  Available presets:\n\n'
    list_presets
    printf '\n  Usage: ec2 up --preset <name> --name <instance-name>\n\n'
    ;;

  # Help
  help|-h|--help)   show_help ;;
  version)          echo "ec2 ops kit v${EC2_VERSION}" ;;

  *)
    err "Unknown command: $COMMAND"
    printf '\n'
    show_help
    exit 1
    ;;
esac
